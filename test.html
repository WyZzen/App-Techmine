<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <title>Upload de fichiers</title>
  </head>
  <body>
    <div class="container mt-5">
      <h2>Sélectionnez des fichiers (PDF ou images) à envoyer</h2>
      <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
          <input
            type="file"
            class="form-control-file"
            id="fileInput"
            accept=".pdf, image/*"
            multiple
            required
          />
        </div>
        <button type="submit" class="btn btn-primary">
          Créer et envoyer le PDF
        </button>
      </form>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
      import {
        getStorage,
        ref as storageRef,
        uploadBytes,
      } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-storage.js";
      import { PDFDocument } from "https://unpkg.com/pdf-lib/dist/pdf-lib.esm.js";

      const firebaseConfig = {
        apiKey: "AIzaSyA5KivS1hhrIufEYwt8T8MN1hguKa3aSMY",
        authDomain: "test-techmine.firebaseapp.com",
        databaseURL:
          "https://test-techmine-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "test-techmine",
        storageBucket: "test-techmine.appspot.com",
        messagingSenderId: "876142620682",
        appId: "1:876142620682:web:5bad29bd4f71d82be6aff3",
        measurementId: "G-2LKJFXNQ58",
      };

      const app = initializeApp(firebaseConfig);
      const storage = getStorage(app);

      document
        .getElementById("uploadForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();
          const fileInput = document.getElementById("fileInput");
          const files = fileInput.files;

          if (files.length > 0) {
            const pdfDoc = await PDFDocument.create();

            for (let i = 0; i < files.length; i++) {
              const file = files[i];

              if (file.type === "application/pdf") {
                const existingPdfBytes = await file.arrayBuffer();
                const existingPdfDoc = await PDFDocument.load(existingPdfBytes);
                const pages = await pdfDoc.copyPages(
                  existingPdfDoc,
                  existingPdfDoc.getPageIndices()
                );
                pages.forEach((page) => pdfDoc.addPage(page));
              } else if (file.type.startsWith("image/")) {
                const imageBytes = await file.arrayBuffer();
                let image;
                if (file.type === "image/png") {
                  image = await pdfDoc.embedPng(imageBytes);
                } else if (file.type === "image/jpeg") {
                  image = await pdfDoc.embedJpg(imageBytes);
                }
                const page = pdfDoc.addPage([image.width, image.height]);
                page.drawImage(image, {
                  x: 0,
                  y: 0,
                  width: image.width,
                  height: image.height,
                });
              }
            }

            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: "application/pdf" });
            const pdfFile = new File([blob], "combined.pdf", {
              type: "application/pdf",
            });

            const storagePath = "uploads/combined.pdf"; // Chemin où le fichier sera stocké
            const storageRefPath = storageRef(storage, storagePath);

            uploadBytes(storageRefPath, pdfFile)
              .then((snapshot) => {
                console.log(
                  "Fichier PDF créé et envoyé avec succès:",
                  snapshot
                );
                alert("Fichier PDF créé et envoyé avec succès!");
              })
              .catch((error) => {
                console.error("Erreur lors de l'envoi du PDF:", error);
                alert("Erreur lors de l'envoi du PDF.");
              });
          }
        });
    </script>
  </body>
</html>

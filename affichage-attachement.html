<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <title>Page d'accueil</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <link rel="stylesheet" href="style-top.css" />
    <style>
      th.sortable {
        cursor: pointer;
        position: relative;
      }

      th.sortable .sort-icon {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
      }

      th.sortable.asc .sort-icon::before {
        content: "\f0de"; /* FontAwesome sort up */
      }

      th.sortable.desc .sort-icon::before {
        content: "\f0dd"; /* FontAwesome sort down */
      }
    </style>
  </head>
  <body class="bg-primary bg-gradient-2">
    <div class="container-fluid align-items-center custom-height-top">
      <div
        class="row bg-gradient bg-white p-4 align-items-center custom-height-top"
      >
        <div class="col col-2 text-start">
          <img
            src="logo techmine.svg"
            alt="bouton de menu"
            class="custom-height-logo"
          />
        </div>
        <div class="col col-8">
          <h1 class="custom-font-top ms-5 text-center">
            Liste des attachements
          </h1>
        </div>
        <div class="col col-2 text-end h-20">
          <div class="dropdown text-center">
            <button
              class="btn dropdown-toggle"
              type="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <img
                src="symbole-de-menu-pour-android.png"
                alt="bouton de menu"
                class="custom-height-menu"
              />
            </button>
            <ul
              class="dropdown-menu dropdown-menu-dark custom-menu text-center"
            >
              <!-- Menu dropdown content -->
            </ul>
          </div>
        </div>
      </div>
      <!-- Tableau pour afficher les attachements -->
      <div class="row mt-4">
        <div class="col">
          <table class="table table-striped">
            <thead>
              <tr>
                <th scope="col" class="sortable" data-index="0">
                  Client <i class="sort-icon fas"></i>
                </th>
                <th scope="col" class="sortable" data-index="1">
                  Chantier <i class="sort-icon fas"></i>
                </th>
                <th scope="col" class="sortable" data-index="2">
                  Date <i class="sort-icon fas"></i>
                </th>
                <th scope="col">Détails</th>
              </tr>
            </thead>
            <tbody id="attachementsTableBody">
              <!-- Les données des attachements seront insérées ici -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getDatabase,
        ref,
        get,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
      import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyA5KivS1hhrIufEYwt8T8MN1hguKa3aSMY",
        authDomain: "test-techmine.firebaseapp.com",
        databaseURL:
          "https://test-techmine-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "test-techmine",
        storageBucket: "test-techmine.appspot.com",
        messagingSenderId: "876142620682",
        appId: "1:876142620682:web:5bad29bd4f71d82be6aff3",
      };

      // Initialisation Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const auth = getAuth(app);

      function fetchAttachements() {
        console.log("dans fetchAttachement");
        const attachementsRef = ref(db, "Attachement/"); // Chemin dans votre base de données
        get(attachementsRef)
          .then((snapshot) => {
            if (snapshot.exists()) {
              const data = snapshot.val();
              console.log(snapshot.val());
              const tableBody = document.getElementById(
                "attachementsTableBody"
              );
              tableBody.innerHTML = ""; // Vider le contenu existant

              // Boucle à travers les attachements et créer des lignes de tableau
              Object.keys(data).forEach((key) => {
                const attachement = data[key];
                const row = `
                      <tr>
                        <td>${attachement.infos.client}</td>
                        <td>${attachement.infos.chantier}</td>
                        <td>${attachement.date}</td>
                        <td><a href="Impression-attachement.html?number=${key}" class="btn btn-primary">Voir</a></td>
                      </tr>
                    `;
                tableBody.innerHTML += row; // Ajouter la ligne au tableau
              });
            } else {
              console.log("Aucun attachement trouvé.");
            }
          })
          .catch((error) => {
            console.error(
              "Erreur lors de la récupération des attachements :",
              error
            );
          });
      }

      function sortTable(columnIndex) {
        const table = document.querySelector("table");
        const rows = Array.from(table.querySelectorAll("tbody tr"));
        const header = table.querySelectorAll("thead th")[columnIndex];
        const currentIsAsc = header.classList.contains("asc");

        const sortedRows = rows.sort((a, b) => {
          const aText = a.children[columnIndex].innerText.trim();
          const bText = b.children[columnIndex].innerText.trim();

          if (columnIndex === 2) {
            // tri
            const aDate = new Date(aText);
            const bDate = new Date(bText);

            if (isNaN(aDate.getTime()) || isNaN(bDate.getTime())) {
              console.error(`Invalid date found: ${aText} or ${bText}`);
              return 0; // If dates are invalid, do not change their order
            }

            return currentIsAsc ? aDate - bDate : bDate - aDate;
          } else {
            return currentIsAsc
              ? aText.localeCompare(bText)
              : bText.localeCompare(aText);
          }
        });

        header.classList.toggle("asc", !currentIsAsc);
        header.classList.toggle("desc", currentIsAsc);

        const tableBody = document.getElementById("attachementsTableBody");
        tableBody.innerHTML = "";
        sortedRows.forEach((row) => tableBody.appendChild(row));
      }

      // Ajouter les événements de clic pour les en-têtes de colonnes triables
      document.querySelectorAll("th.sortable").forEach((th) => {
        th.addEventListener("click", () => {
          const index = th.getAttribute("data-index");
          sortTable(parseInt(index));
        });
      });

      // Gestion de l'état d'authentification
      auth.onAuthStateChanged((user) => {
        if (user) {
          fetchAttachements();
        } else {
          fetchAttachements();
          console.log("Utilisateur non connecté");
        }
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <!-- Ajout de la bibliothèque jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  </head>
  <body class="h4">
    <style>
      div {
        margin-left: 5vh;
      }
    </style>
    <div class="text-start">
      <img
        id="logo"
        src="logo techmine.svg"
        alt="Logo"
        class="img"
        style="height: 25vh"
      />
    </div>
    <div id="client"></div>
    <br />
    <div id="chantier"></div>
    <br />
    <div id="HForreuse"></div>
    <div id="NbMF"></div>
    <br />
    <div id="HArret"></div>
    <div id="CommA"></div>
    <br />
    <div id="HPanne"></div>
    <div id="CommP"></div>

    <button id="btnShare" class="btn btn-primary m-4">
      Partager l'attachement en PDF
    </button>
    <script type="module">
      let UserCreds = JSON.parse(sessionStorage.getItem("UserCreds"));
      let UserInfo = JSON.parse(sessionStorage.getItem("UserInfo"));

      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyA5KivS1hhrIufEYwt8T8MN1hguKa3aSMY",
        authDomain: "test-techmine.firebaseapp.com",
        databaseURL:
          "https://test-techmine-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "test-techmine",
        storageBucket: "test-techmine.appspot.com",
        messagingSenderId: "876142620682",
        appId: "1:876142620682:web:5bad29bd4f71d82be6aff3",
        measurementId: "G-2LKJFXNQ58",
      };

      const app = initializeApp(firebaseConfig);

      import {
        getDatabase,
        ref,
        get,
      } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";

      const db = getDatabase();
      const auth = getAuth();
      const number = getURLParameter("id");

      function getURLParameter(name) {
        return new URLSearchParams(window.location.search).get(name);
      }

      async function getAttachement() {
        const attachmentRef = ref(db, "rapport/" + number);
        const divChantier = document.getElementById("chantier");
        const divClient = document.getElementById("client");
        const divHForreuse = document.getElementById("HForreuse");
        const divHArret = document.getElementById("HArret");
        const divCommA = document.getElementById("CommA");
        const divHPanne = document.getElementById("HPanne");
        const divCommP = document.getElementById("CommP");
        const divNbHF = document.getElementById("NbMF");
        let Hforreuse = 0;

        const snapshot = await get(attachmentRef);
        const infos = snapshot.val().infos;

        Hforreuse = infos.NbHF - infos.NbHD;

        divChantier.textContent = "chantier : " + infos.Carriere;
        divClient.textContent = "client : " + infos.client;
        divHForreuse.textContent = "heures forreuse : " + Hforreuse;
        divHArret.textContent = "heures d'arret : " + infos.NbHA;
        divCommA.textContent = "commentaire : " + infos.CommA;
        divHPanne.textContent = "heures de panne : " + infos.NbHP;
        divCommP.textContent = "commentaire : " + infos.CommP;
        divNbHF.textContent = "Nombre de mètres forés : " + infos.NbMF;
      }

      getAttachement();

      // Fonction pour convertir l'image en base64
      function getBase64Image(img) {
        const canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        return canvas.toDataURL("image/png");
      }

      // Fonction pour générer le PDF et l'ouvrir dans le menu de partage natif
      async function generateAndSharePDF() {
        // Vérifier la compatibilité du navigateur pour l'API de partage
        if (navigator.share) {
          // Utilisation de jsPDF à partir de window.jspdf.jsPDF
          const { jsPDF } = window.jspdf;

          // Créer un document PDF au format paysage
          const doc = new jsPDF({ orientation: "landscape" });

          // Récupérer le logo en base64
          const logoImg = document.getElementById("logo");
          const logoBase64 = getBase64Image(logoImg);

          // Ajouter le logo dans le PDF
          doc.addImage(logoBase64, "PNG", 10, 10, 50, 30); // Position et taille du logo dans le PDF

          // Ajouter du texte dans le PDF (exemple basique)
          doc.text(document.getElementById("client").textContent, 10, 50);
          doc.text(document.getElementById("chantier").textContent, 10, 60);
          doc.text(document.getElementById("HForreuse").textContent, 10, 70);
          doc.text(document.getElementById("NbMF").textContent, 10, 80);
          doc.text(document.getElementById("HArret").textContent, 10, 90);
          doc.text(document.getElementById("CommA").textContent, 10, 100);
          doc.text(document.getElementById("HPanne").textContent, 10, 110);
          doc.text(document.getElementById("CommP").textContent, 10, 120);

          // Sauvegarde du PDF en blob
          const pdfBlob = doc.output("blob");

          try {
            // Partager le PDF en utilisant l'API Web Share
            await navigator.share({
              files: [
                new File([pdfBlob], "rapport.pdf", { type: "application/pdf" }),
              ],
              title: "Rapport PDF",
              text: "Voici le rapport en PDF",
            });
          } catch (error) {
            console.log("Erreur lors du partage:", error);
          }
        } else {
          alert("Le partage de fichiers n'est pas supporté sur ce navigateur.");
        }
      }

      // Écouteur pour le bouton de partage
      document
        .getElementById("btnShare")
        .addEventListener("click", generateAndSharePDF);
    </script>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <title>Liste des Signalements</title>
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style-top.css" />
  </head>
  <body>
    <div class="container-fluid align-items-center custom-height-top">
      <div
        class="row bg-gradient bg-primary p-4 align-items-center custom-height-top"
      >
        <div class="col col-2 text-start">
          <img
            src="logo techmine.svg"
            alt="bouton de menu"
            class="custom-height-logo"
          />
        </div>
        <div class="col col-8 text-center">
          <h1 class="custom-font-top ms-5">Accueil</h1>
        </div>
        <div class="col col-2 text-end h-20">
          <div class="dropdown text-center">
            <button
              class="btn dropdown-toggle"
              type="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <img
                src="symbole-de-menu-pour-android.png"
                alt="bouton de menu"
                class="custom-height-menu"
              />
            </button>
            <ul
              class="dropdown-menu dropdown-menu-dark custom-menu text-center"
            >
              <li>
                <a class="dropdown-item" href="accueil.html"
                  >Retourner à l'accueil</a
                >
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li><a class="dropdown-item" href="rapport.html">Rapports</a></li>
              <li>
                <a class="dropdown-item" href="liste-rapport.html"
                  >Liste des Rapports</a
                >
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <a class="dropdown-item" href="attachement.html"
                  >Attachements</a
                >
              </li>
              <li>
                <a class="dropdown-item" href="liste-attachement.html"
                  >Liste des attachements</a
                >
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <a class="dropdown-item" href="signalement.html">Signalement</a>
              </li>
              <li>
                <a class="dropdown-item" href="liste-intervention.html"
                  >Liste des interventions</a
                >
              </li>
              <li>
                <a class="dropdown-item" href="historique-intervention.html"
                  >Historique des interventions</a
                >
              </li>
              <li><hr class="dropdown-divider menu-item-admin" /></li>
              <li><hr class="dropdown-divider menu-item-admin" /></li>
              <li class="menu-item-admin">
                <div class="dropdown-header" style="font-size: 2rem">
                  Administrateur
                </div>
              </li>
              <li class="menu-item-admin">
                <a class="dropdown-item" href="ajout-utilisateur.html"
                  >Gestion des Utilisateurs</a
                >
              </li>
              <li class="menu-item-admin">
                <a class="dropdown-item" href="ajout-client.html"
                  >Gestion des Clients</a
                >
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="container-fluid mt-5">
      <h1 class="mb-4">Liste des Rapports</h1>
      <div class="table-responsive">
        <button id="exportButton" class="btn btn-primary mt-3">
          Exporter en CSV
        </button>
        <table
          id="signalementsTable"
          class="table table-striped table-bordered"
        >
          <thead class="thead-dark">
            <tr>
              <!-- Add an extra column for actions -->
              <th>Date</th>
              <th>Opérateur</th>
              <th>Machine</th>
              <th>Heures Forreuse</th>
              <th>Heures Marteau</th>
              <th>Observations</th>
              <th>Priorité</th>
              <th>Commentaire</th>
              <th>Prochaine VGP</th>
              <th>Prochaine Révision</th>
              <th>Prochaine Vidange</th>
              <th>Contôle Cuve Périodique</th>
              <th>Contôle Cuve Recalif</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyA5KivS1hhrIufEYwt8T8MN1hguKa3aSMY",
        authDomain: "test-techmine.firebaseapp.com",
        databaseURL:
          "https://test-techmine-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "test-techmine",
        storageBucket: "test-techmine.appspot.com",
        messagingSenderId: "876142620682",
        appId: "1:876142620682:web:5bad29bd4f71d82be6aff3",
        measurementId: "G-2LKJFXNQ58",
      };

      const app = initializeApp(firebaseConfig);

      import {
        getDatabase,
        ref,
        child,
        get,
        set,
        update,
        remove,
        onValue,
      } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";

      const db = getDatabase();
      const auth = getAuth();

      let user = sessionStorage.getItem("user-uid");
      let currentUserId = null;
      let currentUserRole = null;

      function fetchSignalement() {
        const signalementRef = ref(db, "signalement");
        const usersRef = ref(db, "users");
        const machinesRef = ref(db, "machine");

        Promise.all([get(usersRef), get(machinesRef)]).then((snapshots) => {
          const usersSnapshot = snapshots[0];
          const machinesSnapshot = snapshots[1];

          const users = usersSnapshot.val() || {};
          const machines = machinesSnapshot.val() || {};

          onValue(signalementRef, (snapshot) => {
            const signalements = snapshot.val() || {};
            const signalementsTableBody = document
              .getElementById("signalementsTable")
              .getElementsByTagName("tbody")[0];

            signalementsTableBody.innerHTML = "";

            for (const signalementId in signalements) {
              const signalement = signalements[signalementId];
              const userId = signalement.operator;
              const machineId = signalement.machine;

              const user = users[userId] || {
                prenom: "Utilisateur",
                nom: "Inconnu",
              };

              const machineName = machines[machineId]
                ? machines[machineId].nom
                : "Machine Inconnue";

              let textPriorite = "";
              if (signalement.priorite == 0) {
                textPriorite = "non renseignée";
              } else if (signalement.priorite == 1) {
                textPriorite = "vidange";
              } else if (signalement.priorite == 2) {
                textPriorite = "Intervention à prévoir sous 15 jours";
              } else if (signalement.priorite == 3) {
                textPriorite = "Intervention à prévoir sous 10 jours";
              } else if (signalement.priorite == 4) {
                textPriorite = "Intervention à prévoir rapidement (Arrêt)";
              }

              const row = signalementsTableBody.insertRow();
              row.insertCell(0).textContent = signalement.date;
              row.insertCell(1).textContent = `${user.nom} ${user.prenom}`;
              row.insertCell(2).textContent = machineName;
              row.insertCell(3).textContent = signalement.HeuresForreuse;
              row.insertCell(4).textContent = signalement.HeuresMarteau;
              row.insertCell(5).textContent = signalement.observations;
              row.insertCell(6).textContent = textPriorite;
              row.insertCell(7).textContent = signalement.commentaire;
              row.insertCell(8).textContent = signalement.PVGP;
              row.insertCell(9).textContent = signalement.PRevision;
              row.insertCell(10).textContent = signalement.PVidange;
              row.insertCell(11).textContent = signalement.CCP;
              row.insertCell(12).textContent = signalement.CCR;

              const currentTime = new Date().getTime();
              const attachmentTime = signalementId;
              const timeDifference = currentTime - attachmentTime;
              console.log(
                signalementId,
                currentTime,
                attachmentTime,
                timeDifference
              );
              if (timeDifference < 3600000) {
                const actionsCell = row.insertCell(13);
                const deleteButton = document.createElement("button");
                deleteButton.className = "btn btn-danger btn-sm mr-2";
                deleteButton.textContent = "Supprimer";
                deleteButton.onclick = () => {
                  deleteAttachment(signalementId);
                };

                actionsCell.appendChild(deleteButton);
              } else {
                row.insertCell(13).textContent = "";
              }
            }

            if ($.fn.DataTable.isDataTable("#signalementsTable")) {
              $("#signalementsTable").DataTable().clear().destroy();
            }

            $("#signalementsTable").DataTable({
              order: [[1, "asc"]],
              columnDefs: [{ orderable: true, targets: [1, 0] }],
              paging: true,
              searching: true,
            });
          });
        });
      }

      function exportRapportsToCSV() {
        const signalementsRef = ref(db, "signalement");
        const usersRef = ref(db, "users");
        const machinesRef = ref(db, "machine");

        Promise.all([get(signalementsRef), get(usersRef), get(machinesRef)])
          .then((results) => {
            const signalementSnapshot = results[0];
            const usersSnapshot = results[1];
            const machinesSnapshot = results[2];

            const signalements = signalementSnapshot.val();
            const users = usersSnapshot.val();
            const machines = machinesSnapshot.val();

            if (!signalements) {
              alert("Aucun rapport trouvé.");
              return;
            }

            let csvContent =
              "\uFEFF" +
              [
                "Date",
                "Opérateur",
                "Machine",
                "Heures Forreuse",
                "Heures Marteau",
                "Observations",
                "Priorité",
                "Commentaire",
                "Prochaine VGP",
                "Prochaine Révision",
                "Prochaine Vidange",
                "Contôle Cuve Périodique",
                "Contôle Cuve Recalif",
              ].join(";") +
              "\n";

            Object.keys(signalements).forEach((key) => {
              const signalement = signalements[key];
              const userId = signalement.operator;
              const machineId = signalement.machine;

              const operator = users[userId]
                ? `${users[userId].prenom} ${users[userId].nom}`
                : "Utilisateur Inconnu";

              const machineName = machines[machineId]
                ? machines[machineId].name
                : "Machine Inconnue";

              const row = [
                signalement.date,
                operator,
                machineName,
                signalement.HeuresForreuse,
                signalement.HeuresMarteau,
                signalement.observations,
                signalement.priorite,
                signalement.commentaire,
                signalement.PVGP,
                signalement.PRevision,
                signalement.PVidange,
                signalement.CCP,
                signalement.CCR,
              ].join(";");

              csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute(
              "href",
              "data:text/csv;charset=utf-8," + encodedUri
            );
            link.setAttribute("download", "rapports.csv");
            document.body.appendChild(link);

            link.click();
            document.body.removeChild(link);
          })
          .catch((error) => {
            console.error(
              "Erreur lors de la récupération des rapports:",
              error
            );
            alert(
              "Erreur lors de la récupération des rapports. Veuillez consulter la console pour plus de détails."
            );
          });
      }

      function deleteAttachment(signalementId) {
        const signalementsRef = ref(db, `Signalement/${signalementId}`);

        // Supprimer le signalement de la base de données
        remove(signalementsRef)
          .then(() => {
            alert("Signalement supprimé avec succès.");
            fetchSignalement();
          })
          .catch((error) => {
            console.error(
              "Erreur lors de la suppression du signalement:",
              error
            );
            alert("Erreur lors de la suppression du signalements.");
          });
      }

      function checkUserRole(userId) {
        const userRef = ref(db, `users/${userId}`);
        return get(userRef).then((snapshot) => {
          const userData = snapshot.val();
          return {
            isAdmin:
              userData.role === "cadre" ||
              userData.role === "responsable exploitation" ||
              userData.role === "directeur" ||
              userData.role === "responsable agence",
            role: userData.role,
          };
        });
      }

      auth.onAuthStateChanged((user) => {
        if (user) {
          currentUserId = user.uid;
          console.log("Utilisateur connecté:", user.uid);
          checkUserRole(user.uid)
            .then((userInfo) => {
              currentUserRole = userInfo.role;
              const adminMenuItems =
                document.querySelectorAll(".menu-item-admin");
              adminMenuItems.forEach((item) => {
                item.style.display = userInfo.isAdmin ? "block" : "none";
              });
              fetchSignalement();
            })
            .catch((error) => {
              console.error("Erreur lors de la vérification du rôle :", error);
              const adminMenuItems =
                document.querySelectorAll(".menu-item-admin");
              adminMenuItems.forEach((item) => {
                item.style.display = "none";
              });
            });
        } else {
          const adminMenuItems = document.querySelectorAll(".menu-item-admin");
          adminMenuItems.forEach((item) => {
            item.style.display = "none";
          });
        }
      });

      document
        .getElementById("exportButton")
        .addEventListener("click", exportRapportsToCSV);

      console.log(currentUserId);
      console.log(currentUserRole);
    </script>
  </body>
</html>
